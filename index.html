<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>招标采购人工具箱 - 专业版</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        body { font-family: 'Inter', system-ui, -apple-system, sans-serif; background-color: #f8fafc; }
        .fade-in { animation: fadeIn 0.3s ease-in-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        input[type="number"]::-webkit-inner-spin-button,
        input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        .timeline-line { position: absolute; left: 15px; top: 24px; bottom: 0; width: 2px; background: #e2e8f0; z-index: 0; }
        .timeline-item:last-child .timeline-line { display: none; }
        
        /* 打印样式 */
        @media print {
            body * { visibility: hidden; }
            .no-print, header, footer, .nav-sidebar { display: none !important; }
            #invoice-print-area, #invoice-print-area * { visibility: visible; }
            #invoice-print-area { position: absolute; left: 0; top: 0; width: 100%; margin: 0; padding: 0; }
            .invoice-page { page-break-after: always; width: 100%; height: 100vh; padding: 10mm; }
            .invoice-page:last-child { page-break-after: auto; }
            .print-dashed-border { border-style: dashed !important; border-width: 1px !important; border-color: #9ca3af !important; }
            .print-hide-bg { background-color: transparent !important; }
            .print-only, .print-only * { visibility: visible; }
            .print-only { position: absolute !important; top: 0 !important; left: 0 !important; width: 100% !important; margin: 0 !important; padding: 0 !important; display: block !important; background: white; }
        }
        .print-only { display: none; }
        
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .custom-scrollbar::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        
        .tool-section { display: none; }
        .tool-section.active { display: block; }
        .nav-item { cursor: pointer; transition: all 0.2s; }
        .nav-item:hover { background-color: #f1f5f9; }
        .nav-item.active { background-color: #dbeafe; border-left: 3px solid #2563eb; color: #1d4ed8; }
    </style>
</head>
<body class="min-h-screen flex">
    <!-- 左侧导航栏 -->
    <aside class="nav-sidebar w-64 bg-white border-r border-slate-200 fixed h-full overflow-y-auto custom-scrollbar z-10">
        <div class="p-4 border-b border-slate-200">
            <div class="flex items-center gap-2">
                <div class="w-10 h-10 bg-gradient-to-br from-blue-600 to-blue-800 rounded-lg flex items-center justify-center">
                    <i class="fas fa-toolbox text-white text-xl"></i>
                </div>
                <div>
                    <h1 class="font-bold text-slate-800 text-sm">招标采购人工具箱</h1>
                    <p class="text-xs text-slate-500">专业版 v3.0</p>
                </div>
            </div>
        </div>
        <nav class="py-2">
            <div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase">收费计算</div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="consulting">
                <i class="fas fa-chart-line w-5 text-center text-indigo-500"></i>
                <span>前期咨询收费</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="design">
                <i class="fas fa-pen-ruler w-5 text-center text-orange-500"></i>
                <span>工程设计收费</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="cost">
                <i class="fas fa-calculator w-5 text-center text-blue-500"></i>
                <span>工程造价收费</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="supervision">
                <i class="fas fa-clipboard-check w-5 text-center text-teal-500"></i>
                <span>工程监理收费</span>
            </div>
            
            <div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase mt-2">专家系统</div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="expert-draw">
                <i class="fas fa-users w-5 text-center text-purple-500"></i>
                <span>专家抽取系统</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="expert-fee">
                <i class="fas fa-user-tie w-5 text-center text-purple-600"></i>
                <span>专家评审费估算</span>
            </div>
            
            <div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase mt-2">代理服务</div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="agency">
                <i class="fas fa-handshake w-5 text-center text-blue-600"></i>
                <span>招标代理服务费</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="transaction">
                <i class="fas fa-building w-5 text-center text-emerald-500"></i>
                <span>交易服务费</span>
            </div>
            
            <div class="px-4 py-2 text-xs font-bold text-slate-400 uppercase mt-2">工具助手</div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="timelimit">
                <i class="fas fa-business-time w-5 text-center text-teal-600"></i>
                <span>依法招标时限计算</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="datecalc">
                <i class="fas fa-calendar-alt w-5 text-center text-cyan-500"></i>
                <span>日期计算助手</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="random">
                <i class="fas fa-dice w-5 text-center text-red-500"></i>
                <span>随机抽取系统</span>
            </div>
            <div class="nav-item px-4 py-3 flex items-center gap-3 text-sm text-slate-700" data-tool="invoice">
                <i class="fas fa-print w-5 text-center text-pink-500"></i>
                <span>发票打印助手</span>
            </div>
        </nav>
    </aside>

    <!-- 主内容区 -->
    <main class="flex-1 ml-64 p-6">
        <!-- ========== 1. 前期咨询收费 ========== -->
        <section id="tool-consulting" class="tool-section">
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-chart-line text-indigo-500"></i>前期咨询收费
                </h2>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-sm text-blue-700">
                    依据：计价格[1999]1283号
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">估算投资额</label>
                                <div class="flex">
                                    <input type="number" id="consult-invest" class="w-full p-3 border border-slate-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="请输入金额">
                                    <select id="consult-unit" class="bg-slate-100 border border-l-0 border-slate-300 rounded-r-lg px-3">
                                        <option value="wanyuan">万元</option>
                                        <option value="yiyuan">亿元</option>
                                    </select>
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">咨询项目类型</label>
                                <select id="consult-type" class="w-full p-3 border border-slate-300 rounded-lg bg-white">
                                    <option value="proposal_prep">编制项目建议书</option>
                                    <option value="feasibility_prep">编制可行性研究报告</option>
                                    <option value="proposal_eval">评估项目建议书</option>
                                    <option value="feasibility_eval">评估可行性研究报告</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">行业调整系数</label>
                                <input type="number" id="consult-coeff" step="0.1" value="1.0" class="w-full p-3 border border-slate-300 rounded-lg">
                            </div>
                        </div>
                    </div>
                    <div class="bg-gradient-to-br from-blue-600 to-indigo-700 rounded-xl p-6 text-white shadow-lg">
                        <h3 class="text-blue-100 text-sm font-bold uppercase tracking-wider mb-2">收费基准价</h3>
                        <div class="text-4xl font-bold" id="consult-result">0.00 <span class="text-lg font-normal">万元</span></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 2. 工程设计收费 ========== -->
        <section id="tool-design" class="tool-section">
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-pen-ruler text-orange-500"></i>工程设计收费
                </h2>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-sm text-blue-700">
                    依据：计价格[2002]10号
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">计费额 (概算投资) <span class="text-slate-400 font-normal">万元</span></label>
                                <input type="number" id="design-invest" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none" placeholder="例如 5000">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">专业分类系数</label>
                                <select id="design-prof" class="w-full p-3 border border-slate-300 rounded-lg bg-white">
                                    <option value="1.0">建筑、市政 (1.0)</option>
                                    <option value="1.1">人防、园林、地铁 (1.1)</option>
                                    <option value="0.9">公路、城市道路 (0.9)</option>
                                    <option value="1.2">石油化工、水利水电 (1.2)</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">复杂程度系数</label>
                                    <input type="number" id="design-complex" step="0.1" value="1.0" class="w-full p-3 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">附加调整系数</label>
                                    <input type="number" id="design-add" step="0.1" value="1.0" class="w-full p-3 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">浮动幅度 (%)</label>
                                <input type="number" id="design-float" value="0" class="w-full p-3 border border-slate-300 rounded-lg" placeholder="-20 到 20">
                            </div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-gradient-to-br from-orange-500 to-orange-700 rounded-xl p-6 text-white shadow-lg">
                            <h3 class="text-orange-100 text-sm font-bold uppercase tracking-wider mb-2">设计收费总额</h3>
                            <div class="text-4xl font-bold" id="design-total">0.00 <span class="text-lg text-orange-200 font-normal">万元</span></div>
                            <div class="mt-4 pt-4 border-t border-orange-500/30 text-sm opacity-80">
                                <div>基本设计收费: <span id="design-basic">0.00</span> 万元</div>
                                <div>基准价: <span id="design-base">0.00</span> 万元</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 3. 工程造价收费 ========== -->
        <section id="tool-cost" class="tool-section">
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-calculator text-blue-500"></i>工程造价收费
                </h2>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-sm text-blue-700">
                    依据：中价协﹝2013﹞35号文件标准
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <h3 class="text-lg font-semibold border-b pb-3 mb-4 flex items-center">
                            <i class="fas fa-cog mr-2 text-blue-600"></i>参数设置
                        </h3>
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">咨询项目名称</label>
                                <select id="cost-type" class="w-full border border-slate-300 rounded-lg p-3 bg-white">
                                    <option value="0">工程概算编制</option>
                                    <option value="1">工程量清单编制</option>
                                    <option value="2">招标控制价编制</option>
                                    <option value="3">工程预算编制</option>
                                    <option value="4">工程结算审查</option>
                                    <option value="5">全过程造价咨询</option>
                                    <option value="6">竣工决算编制</option>
                                    <option value="7">工程造价纠纷鉴定</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">建安工程费/收费基数 (万元)</label>
                                <input type="number" id="cost-base" placeholder="请输入造价金额" class="w-full border border-slate-300 rounded-lg p-3">
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">专业工程类别</label>
                                <select id="cost-prof" class="w-full border border-slate-300 rounded-lg p-3 bg-white">
                                    <option value="1.0">房屋建筑工程 (1.0)</option>
                                    <option value="0.8">市政工程 (0.8)</option>
                                    <option value="0.9">水利电力工程 (0.9)</option>
                                    <option value="0.7">机场场道/桥梁/隧道 (0.7)</option>
                                    <option value="0.8">公路/道路/轨道/港口 (0.8)</option>
                                    <option value="1.1">井巷矿山/园林绿化 (1.1)</option>
                                    <option value="1.2">装饰装修/仿古/安装 (1.2)</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-slate-700 mb-1">地区调整系数 (0.9 - 1.1)</label>
                                <input type="number" id="cost-region" value="1.0" step="0.01" min="0.9" max="1.1" class="w-full border border-slate-300 rounded-lg p-3">
                            </div>
                            <div class="pt-2 border-t">
                                <label class="flex items-center space-x-2 cursor-pointer">
                                    <input type="checkbox" id="cost-steel-check" class="rounded text-blue-600 w-4 h-4">
                                    <span class="text-sm font-medium text-slate-700">计算钢筋精细计量附加费</span>
                                </label>
                                <div id="cost-steel-input" class="hidden mt-2">
                                    <label class="block text-xs text-slate-500 mb-1">钢筋重量 (吨)</label>
                                    <input type="number" id="cost-steel-weight" placeholder="请输入重量" class="w-full border border-slate-300 rounded-lg p-2">
                                </div>
                            </div>
                        </div>
                        <button onclick="calculateCost()" class="w-full mt-6 bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition">开始计算</button>
                    </div>
                    <div class="space-y-4">
                        <div class="bg-gradient-to-br from-blue-50 to-white rounded-xl shadow-sm border border-slate-200 p-6">
                            <h3 class="text-lg font-semibold border-b pb-3 mb-4">计算结果汇总</h3>
                            <div id="cost-placeholder" class="flex flex-col items-center justify-center h-48 text-slate-400">
                                <i class="fas fa-info-circle text-4xl mb-2"></i>
                                <p>请输入参数并点击计算</p>
                            </div>
                            <div id="cost-content" class="hidden">
                                <div class="mb-6">
                                    <span class="text-slate-600 text-sm">收费基准价 (差额累进)</span>
                                    <div class="text-2xl font-bold text-blue-700"><span id="cost-res-base">0.00</span> 元</div>
                                </div>
                                <div class="grid grid-cols-2 gap-4 mb-6 text-sm text-slate-600">
                                    <div>专业调整: <span id="cost-res-prof" class="font-medium text-slate-800">1.0</span></div>
                                    <div>地区调整: <span id="cost-res-reg" class="font-medium text-slate-800">1.0</span></div>
                                    <div class="col-span-2">钢筋附加费: <span id="cost-res-steel" class="font-medium text-slate-800">0.00</span> 元</div>
                                </div>
                                <div class="border-t pt-4 mb-4">
                                    <span class="text-slate-800 font-bold text-lg">最终咨询服务费总额</span>
                                    <div class="text-3xl font-extrabold text-red-600 mt-1">¥ <span id="cost-res-total">0.00</span></div>
                                </div>
                            </div>
                        </div>
                        <div id="cost-detail" class="hidden bg-white rounded-xl shadow-sm border border-slate-200 p-6 overflow-x-auto">
                            <h2 class="text-lg font-semibold mb-4 text-slate-800">差额累进计算明细</h2>
                            <table class="w-full text-sm text-left text-slate-500">
                                <thead class="text-xs text-slate-700 uppercase bg-slate-100">
                                    <tr>
                                        <th class="px-4 py-2">分档区间 (万元)</th>
                                        <th class="px-4 py-2">费率 (‰)</th>
                                        <th class="px-4 py-2">该档计算基数</th>
                                        <th class="px-4 py-2">小计 (元)</th>
                                    </tr>
                                </thead>
                                <tbody id="cost-detail-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 4. 工程监理收费 ========== -->
        <section id="tool-supervision" class="tool-section">
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-clipboard-check text-teal-500"></i>工程监理收费
                </h2>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-sm text-blue-700">
                    依据：发改价格〔2007〕670号
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="space-y-4">
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">计费额 (建安费) <span class="text-slate-400 font-normal">万元</span></label>
                                <input type="number" id="super-invest" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500 outline-none">
                            </div>
                            <div>
                                <label class="block text-sm font-semibold text-slate-700 mb-1">专业系数</label>
                                <select id="super-ind" class="w-full p-3 border border-slate-300 rounded-lg bg-white">
                                    <option value="1.0">建筑、市政、火电 (1.0)</option>
                                    <option value="0.8">园林绿化 (0.8)</option>
                                    <option value="1.1">地铁、桥梁 (1.1)</option>
                                </select>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">复杂程度系数</label>
                                    <input type="number" id="super-comp" step="0.1" value="1.0" class="w-full p-3 border border-slate-300 rounded-lg">
                                </div>
                                <div>
                                    <label class="block text-sm font-semibold text-slate-700 mb-1">浮动幅度 (%)</label>
                                    <input type="number" id="super-float" value="0" class="w-full p-3 border border-slate-300 rounded-lg">
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="space-y-6">
                        <div class="bg-gradient-to-br from-teal-500 to-teal-700 rounded-xl p-6 text-white shadow-lg">
                            <h3 class="text-teal-100 text-sm font-bold uppercase tracking-wider mb-2">监理收费总额</h3>
                            <div class="text-4xl font-bold" id="super-total">0.00 <span class="text-lg text-teal-200 font-normal">万元</span></div>
                            <div class="mt-4 pt-4 border-t border-teal-500/30 text-sm opacity-80">
                                基准价: <span id="super-base">0.00</span> 万元
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 5. 专家抽取系统 ========== -->
        <section id="tool-expert-draw" class="tool-section">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-users text-purple-500"></i>专家抽取系统
                </h2>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- 左侧：项目信息与规则配置 -->
                    <div class="space-y-4">
                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">1</span> 
                                项目信息与数据
                            </h3>
                            <div class="space-y-3 text-sm">
                                <input type="text" id="expert-project-name" class="w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="项目名称">
                                <input type="text" id="expert-project-code" class="w-full border border-slate-300 rounded-lg px-3 py-2" placeholder="项目编号">
                                <div class="pt-3 border-t mt-2">
                                    <div class="flex justify-between items-center mb-2">
                                        <label class="text-xs font-bold text-slate-600">专家库文件 (.csv)</label>
                                        <div class="flex items-center gap-1">
                                            <span class="text-xs text-slate-500">编码:</span>
                                            <select id="expert-encoding" class="text-xs border rounded p-1 bg-slate-50">
                                                <option value="GBK">GBK</option>
                                                <option value="UTF-8">UTF-8</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="grid grid-cols-2 gap-2">
                                        <label class="border rounded-lg p-3 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-slate-50" id="gov-upload-label">
                                            <i class="fas fa-upload text-blue-600"></i>
                                            <span class="text-sm font-medium">政府采购库</span>
                                            <span class="text-xs text-slate-400" id="gov-count">点击上传</span>
                                            <input type="file" accept=".csv" class="hidden" id="gov-file" onchange="handleExpertFile(this, 'gov')">
                                        </label>
                                        <label class="border rounded-lg p-3 flex flex-col items-center justify-center gap-1 cursor-pointer hover:bg-slate-50" id="comp-upload-label">
                                            <i class="fas fa-upload text-green-600"></i>
                                            <span class="text-sm font-medium">综合库</span>
                                            <span class="text-xs text-slate-400" id="comp-count">点击上传</span>
                                            <input type="file" accept=".csv" class="hidden" id="comp-file" onchange="handleExpertFile(this, 'comp')">
                                        </label>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-5">
                            <h3 class="font-bold text-slate-700 mb-4 flex items-center gap-2">
                                <span class="bg-blue-100 text-blue-600 rounded-full w-6 h-6 flex items-center justify-center text-xs">2</span> 
                                抽取规则配置
                            </h3>
                            <div class="flex bg-slate-100 p-1 rounded-lg mb-4">
                                <button onclick="setExpertLib('gov')" id="btn-gov" class="flex-1 py-1.5 text-sm rounded-md transition bg-white shadow text-blue-700 font-bold">政府采购库</button>
                                <button onclick="setExpertLib('comp')" id="btn-comp" class="flex-1 py-1.5 text-sm rounded-md transition text-slate-500 hover:text-slate-700">综合库</button>
                            </div>
                            <div class="bg-blue-50 p-3 rounded-lg border border-blue-100 mb-4 flex items-center justify-between gap-2">
                                <div class="flex gap-2 items-center">
                                    <div class="text-center">
                                        <div class="text-[10px] text-slate-500">评委</div>
                                        <input type="number" id="expert-total" min="1" class="w-12 h-8 text-center border rounded font-bold" value="5">
                                    </div>
                                    <div class="text-slate-400 font-bold">-</div>
                                    <div class="text-center">
                                        <div class="text-[10px] text-slate-500">业主</div>
                                        <input type="number" id="expert-rep" min="0" class="w-12 h-8 text-center border rounded font-bold" value="1">
                                    </div>
                                    <div class="text-slate-400 font-bold">=</div>
                                </div>
                                <div class="text-right">
                                    <div class="text-[10px] text-slate-500">需抽取</div>
                                    <div class="text-2xl font-bold text-blue-700"><span id="expert-needed">4</span> <span class="text-xs font-normal text-slate-500">人</span></div>
                                </div>
                            </div>

                            <div class="bg-slate-50 p-3 rounded-lg border border-slate-200 mb-4">
                                <div class="relative mb-2">
                                    <i class="fas fa-search absolute left-3 top-2.5 text-slate-400"></i>
                                    <input type="text" id="expert-search" placeholder="输入关键字搜索专业..." class="w-full border rounded-lg pl-9 pr-8 py-2 text-sm" oninput="filterMajors()">
                                    <button onclick="clearSearch()" class="absolute right-2 top-2.5 text-slate-400 hover:text-slate-600 hidden" id="clear-search">
                                        <i class="fas fa-times-circle"></i>
                                    </button>
                                </div>
                                <div class="border rounded-lg h-48 overflow-y-auto custom-scrollbar bg-white mb-3 shadow-inner" id="major-list">
                                    <div class="h-full flex flex-col items-center justify-center text-slate-400 text-sm">
                                        <i class="fas fa-search text-2xl mb-2 opacity-20"></i>
                                        请先上传专家库文件
                                    </div>
                                </div>
                                <div class="flex gap-2 items-center">
                                    <div class="flex-1 flex items-center border rounded-lg bg-white overflow-hidden">
                                        <input type="number" id="expert-count" min="1" class="w-full p-2 text-sm outline-none text-center font-medium" value="1" placeholder="数量">
                                        <span class="bg-slate-50 px-3 py-2 text-sm text-slate-500 border-l">人</span>
                                    </div>
                                    <button onclick="addExpertRule()" class="px-4 py-2 bg-slate-800 text-white rounded-lg text-sm hover:bg-black flex items-center gap-1 shadow-sm">
                                        <i class="fas fa-plus"></i> 添加规则
                                    </button>
                                </div>
                                <div class="text-[10px] text-slate-400 text-center mt-2">提示：双击专业名称可快速添加</div>
                            </div>

                            <div class="mb-4 space-y-2">
                                <div class="flex justify-between items-center text-xs font-bold text-slate-600">
                                    <span>已添加规则</span>
                                    <span class="px-2 py-0.5 rounded bg-amber-100 text-amber-700" id="rule-count">0 / 4 人</span>
                                </div>
                                <div class="space-y-2" id="rule-list"></div>
                            </div>

                            <div class="mb-4">
                                <input type="text" id="expert-avoid" placeholder="回避单位关键字 (如：城投, 建工)" class="w-full border border-slate-300 rounded-lg p-2 text-sm">
                            </div>

                            <button onclick="drawExperts()" id="btn-draw" class="w-full py-3 rounded-lg shadow-sm font-bold text-white flex justify-center items-center gap-2 transition bg-slate-400 cursor-not-allowed" disabled>
                                <i class="fas fa-sync-alt"></i> 开始抽取
                            </button>
                        </div>
                    </div>

                    <!-- 右侧：抽取结果 -->
                    <div class="lg:col-span-2 space-y-4">
                        <div class="grid grid-cols-4 gap-3 text-center">
                            <div class="bg-white p-3 rounded-lg shadow-sm border-t-4 border-slate-500">
                                <div class="text-xs text-slate-500">总抽取</div>
                                <div class="font-bold text-xl" id="stat-total">0</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow-sm border-t-4 border-yellow-500">
                                <div class="text-xs text-yellow-600">待确认</div>
                                <div class="font-bold text-xl" id="stat-pending">0</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow-sm border-t-4 border-green-500">
                                <div class="text-xs text-green-600">已确认</div>
                                <div class="font-bold text-xl" id="stat-confirmed">0</div>
                            </div>
                            <div class="bg-white p-3 rounded-lg shadow-sm border-t-4 border-red-500">
                                <div class="text-xs text-red-600">未参加</div>
                                <div class="font-bold text-xl" id="stat-rejected">0</div>
                            </div>
                        </div>

                        <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex flex-col">
                            <div class="p-3 border-b bg-slate-50 flex justify-between items-center">
                                <h3 class="font-bold text-slate-800 flex items-center gap-2">抽取结果 <span class="text-xs font-normal text-slate-500" id="result-count">(0人)</span></h3>
                                <div class="flex gap-2">
                                    <select id="export-format" class="text-xs border rounded p-1">
                                        <option value="csv">CSV</option>
                                        <option value="json">JSON</option>
                                    </select>
                                    <button onclick="exportExperts()" id="btn-export" disabled class="bg-white border hover:bg-slate-50 text-slate-700 px-2 py-1 rounded text-xs flex items-center gap-1">
                                        <i class="fas fa-download"></i> 导出
                                    </button>
                                    <button onclick="showRedrawModal()" id="btn-redraw" disabled class="bg-white border hover:bg-slate-50 text-slate-700 px-2 py-1 rounded text-xs flex items-center gap-1">
                                        <i class="fas fa-sync-alt"></i> 补抽
                                    </button>
                                    <button onclick="clearExperts()" class="text-red-600 hover:bg-red-50 px-2 py-1 rounded text-xs border border-transparent hover:border-red-100">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="overflow-y-auto max-h-96 p-3 custom-scrollbar space-y-2" id="expert-results">
                                <div class="text-center py-16 text-slate-400">
                                    <i class="fas fa-search text-4xl mb-2 opacity-20"></i>
                                    <p class="text-sm">暂无数据，请先配置规则并抽取</p>
                                </div>
                            </div>
                            <div class="p-3 border-t bg-slate-50 flex justify-end">
                                <button onclick="printExperts()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-black flex items-center gap-2">
                                    <i class="fas fa-print"></i> 打印报表
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 6. 专家评审费估算 ========== -->
        <section id="tool-expert-fee" class="tool-section">
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-user-tie text-purple-600"></i>专家评审费估算
                </h2>
                <div class="flex bg-slate-100 p-1 rounded-lg mb-6">
                    <button onclick="setExpertFeeMode('comprehensive')" id="btn-comprehensive" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-white shadow text-blue-600">湖南省综合评标 (2025)</button>
                    <button onclick="setExpertFeeMode('procurement')" id="btn-procurement" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all text-slate-500">湖南省政府采购 (2023)</button>
                </div>
                
                <!-- 综合评标 -->
                <div id="expert-fee-comprehensive" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-4">
                        <label class="flex items-center gap-2 border p-3 rounded-lg bg-white cursor-pointer">
                            <input type="checkbox" id="comp-cancelled" class="w-4 h-4" onchange="calcExpertFee()">
                            <span class="text-sm">项目取消/回避</span>
                        </label>
                        <div id="comp-normal">
                            <div class="p-4 bg-blue-50 rounded-lg border border-blue-100">
                                <label class="text-sm font-bold text-blue-800">第一日评审时长</label>
                                <div class="flex gap-2 mt-2">
                                    <input type="number" id="comp-h1" value="0" class="w-20 p-2 border rounded" oninput="calcExpertFee()">
                                    <span class="self-center">小时</span>
                                    <input type="number" id="comp-m1" value="0" class="w-20 p-2 border rounded" oninput="calcExpertFee()">
                                    <span class="self-center">分</span>
                                </div>
                                <p class="text-xs text-blue-600 mt-2">注：不满30分按30分算，超过30分按1小时算</p>
                            </div>
                            <div class="p-3 border rounded-lg bg-white mt-3">
                                <label class="flex items-center gap-2 mb-2 cursor-pointer">
                                    <input type="checkbox" id="comp-overnight" class="w-4 h-4" onchange="calcExpertFee()">
                                    <span class="text-sm font-medium">隔夜评标 (次日)</span>
                                </label>
                                <div id="comp-day2" class="hidden flex gap-2 mt-2 ml-6">
                                    <input type="number" id="comp-h2" value="0" class="w-16 p-1 border rounded" oninput="calcExpertFee()">
                                    <span class="self-center">时</span>
                                    <input type="number" id="comp-m2" value="0" class="w-16 p-1 border rounded" oninput="calcExpertFee()">
                                    <span class="self-center">分</span>
                                </div>
                            </div>
                            <label class="flex items-center gap-2 mt-3 cursor-pointer">
                                <input type="checkbox" id="comp-chair" class="w-4 h-4" onchange="calcExpertFee()">
                                <span class="text-sm font-medium">我是主任评委 (+100)</span>
                            </label>
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col justify-between">
                        <div>
                            <h4 class="text-sm font-bold text-slate-500">费用明细</h4>
                            <div class="mt-4 space-y-2 text-sm text-slate-600" id="comp-logs"></div>
                        </div>
                        <div class="mt-6 pt-4 border-t flex justify-between items-end">
                            <span>税前合计</span>
                            <span class="text-3xl font-bold text-blue-600" id="comp-total">¥0</span>
                        </div>
                    </div>
                </div>

                <!-- 政府采购 -->
                <div id="expert-fee-procurement" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-4">
                        <div class="flex gap-2">
                            <button onclick="setProcLocation('local')" id="btn-local" class="flex-1 py-1 text-sm border rounded bg-emerald-100 border-emerald-300 text-emerald-800">同城</button>
                            <button onclick="setProcLocation('remote')" id="btn-remote" class="flex-1 py-1 text-sm border rounded bg-white">异地</button>
                        </div>
                        <div class="p-4 bg-emerald-50 rounded-lg border border-emerald-100">
                            <label class="text-sm font-bold text-emerald-800">评审时长</label>
                            <div class="flex gap-2 mt-2">
                                <input type="number" id="proc-h" value="0" class="w-20 p-2 border rounded" oninput="calcExpertFee()">
                                <span class="self-center">小时</span>
                                <input type="number" id="proc-m" value="0" class="w-20 p-2 border rounded" oninput="calcExpertFee()">
                                <span class="self-center">分</span>
                            </div>
                            <div id="proc-level-box" class="hidden mt-2">
                                <label class="text-xs font-bold text-emerald-700 block mb-1">职称级别</label>
                                <select id="proc-level" class="w-full p-1 border rounded text-sm" onchange="calcExpertFee()">
                                    <option value="normal">中级/普通</option>
                                    <option value="senior">高级职称</option>
                                    <option value="professor">教授级</option>
                                    <option value="academician">院士</option>
                                </select>
                            </div>
                        </div>
                        <label class="flex items-center gap-2 mt-2 cursor-pointer">
                            <input type="checkbox" id="proc-leader" class="w-4 h-4" onchange="calcExpertFee()">
                            <span class="text-sm font-medium">评审组长 (+100)</span>
                        </label>
                    </div>
                    <div class="bg-slate-50 rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col justify-between">
                        <div>
                            <h4 class="text-sm font-bold text-slate-500">费用明细</h4>
                            <div class="mt-4 space-y-2 text-sm text-slate-600" id="proc-logs"></div>
                        </div>
                        <div class="mt-6 pt-4 border-t flex justify-between items-end">
                            <span>税后合计</span>
                            <span class="text-3xl font-bold text-emerald-600" id="proc-total">¥0</span>
                        </div>
                    </div>
                </div>
            </div>
        </section>


        <!-- ========== 7. 招标代理服务费 ========== -->
        <section id="tool-agency" class="tool-section">
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-handshake text-blue-600"></i>招标代理服务费
                </h2>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-sm text-blue-700">
                    依据：计价格[2002]1980号 & 发改价格[2011]534号
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-4">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">项目类别</label>
                            <div class="grid grid-cols-3 gap-2">
                                <button onclick="setAgencyType('goods')" id="agency-goods" class="py-2 text-sm rounded border bg-blue-600 text-white">货物</button>
                                <button onclick="setAgencyType('service')" id="agency-service" class="py-2 text-sm rounded border bg-white hover:bg-gray-50">服务</button>
                                <button onclick="setAgencyType('engineering')" id="agency-engineering" class="py-2 text-sm rounded border bg-white hover:bg-gray-50">工程</button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">中标金额 (元)</label>
                            <input type="number" id="agency-amount" class="w-full p-3 border border-slate-300 rounded-lg" oninput="calcAgencyFee()">
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">折扣率 (%)</label>
                            <input type="number" id="agency-discount" value="100" class="w-full p-3 border border-slate-300 rounded-lg" oninput="calcAgencyFee()">
                        </div>
                    </div>
                    <div class="bg-slate-50 rounded-xl shadow-sm border border-slate-200 p-6">
                        <div class="flex justify-between mb-2">
                            <span>标准收费</span>
                            <span class="font-bold" id="agency-base">¥ 0.00</span>
                        </div>
                        <div class="flex justify-between text-xl font-bold text-blue-600 pt-2 border-t">
                            <span>折后收费</span>
                            <span id="agency-final">¥ 0.00</span>
                        </div>
                        <div class="mt-4 text-xs bg-white p-2 border rounded h-40 overflow-auto" id="agency-details"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 8. 交易服务费 ========== -->
        <section id="tool-transaction" class="tool-section">
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-building text-emerald-500"></i>交易服务费
                </h2>
                <div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-6 text-sm text-blue-700">
                    依据：湘发改价费规〔2024〕292号 (湖南省专用)
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 space-y-6">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-2">项目类型</label>
                            <div class="grid grid-cols-2 gap-4">
                                <div onclick="setTransType('construction')" id="trans-construction" class="cursor-pointer border-2 border-blue-600 bg-blue-50 rounded-xl p-4 transition-all">
                                    <div class="font-medium text-blue-700">施工/装修/物资</div>
                                    <div class="text-xs text-blue-600">(40/60)</div>
                                </div>
                                <div onclick="setTransType('service')" id="trans-service" class="cursor-pointer border-2 border-slate-200 rounded-xl p-4 transition-all hover:border-slate-300">
                                    <div class="font-medium text-slate-700">勘察/设计/监理</div>
                                    <div class="text-xs text-slate-500">(100%中标)</div>
                                </div>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1">中标金额 <span class="text-slate-400 font-normal">万元</span></label>
                            <input type="number" id="trans-amount" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-blue-500" placeholder="请输入金额" oninput="calcTransFee()">
                        </div>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" id="trans-special" class="w-4 h-4" onchange="calcTransFee()">
                            <span class="text-sm">难以计算中标额 (按2000元计)</span>
                        </label>
                    </div>
                    <div class="bg-slate-50 rounded-xl shadow-sm border border-slate-200 p-6 flex flex-col justify-center text-center">
                        <div class="text-sm text-slate-500 font-bold uppercase mb-1">交易服务费总额</div>
                        <div class="text-4xl font-bold text-slate-900" id="trans-total">0.00 <span class="text-sm font-normal">元</span></div>
                        <div class="grid grid-cols-2 gap-4 mt-6">
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="text-sm text-slate-600">招标方承担</div>
                                <div class="text-xl font-bold text-blue-600" id="trans-tenderer">0.00</div>
                            </div>
                            <div class="bg-white p-4 rounded-lg border">
                                <div class="text-sm text-slate-600">中标方承担</div>
                                <div class="text-xl font-bold text-green-600" id="trans-winner">0.00</div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 9. 依法招标时限计算 ========== -->
        <section id="tool-timelimit" class="tool-section">
            <div class="max-w-5xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-business-time text-teal-600"></i>依法招标时限计算
                </h2>
                <div class="flex bg-slate-100 p-1 rounded-lg mb-6">
                    <button onclick="setTimeMode('forward')" id="btn-time-forward" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-white shadow text-teal-600">
                        <i class="fas fa-forward mr-2"></i>正推：流程时限
                    </button>
                    <button onclick="setTimeMode('backward')" id="btn-time-backward" class="flex-1 py-3 rounded-lg text-sm font-bold transition-all text-slate-500">
                        <i class="fas fa-history mr-2"></i>倒推：业绩信誉
                    </button>
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 md:p-8">
                    <div class="bg-orange-50 border-l-4 border-orange-400 p-4 mb-8 rounded-r flex gap-3 text-sm">
                        <i class="fas fa-balance-scale text-orange-500 mt-1"></i>
                        <div class="text-orange-800">
                            <div class="font-bold mb-1">法规提示：《民法典》第二百零一条</div>
                            <div class="opacity-90">按照年、月、日计算期间的，开始的当日不计入，自下一日开始计算。</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                        <div>
                            <label class="block text-sm font-semibold text-slate-700 mb-1" id="time-base-label">选择起始日期 (如发布公告日)</label>
                            <input type="date" id="time-base" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-teal-500 outline-none" onchange="calcTimeLimit()">
                        </div>
                        <div id="time-type-box">
                            <label class="block text-sm font-semibold text-slate-700 mb-1">项目类型</label>
                            <div class="flex gap-3">
                                <button onclick="setTenderType('post-qual')" id="btn-post-qual" class="flex-1 py-3 rounded-lg border text-sm font-medium bg-teal-50 border-teal-500 text-teal-700">资格后审</button>
                                <button onclick="setTenderType('pre-qual')" id="btn-pre-qual" class="flex-1 py-3 rounded-lg border text-sm font-medium bg-white text-slate-500 hover:bg-slate-50">资格预审</button>
                            </div>
                        </div>
                        <div id="time-days-box" class="hidden">
                            <label class="block text-sm font-semibold text-slate-700 mb-1">自定义倒推天数</label>
                            <input type="number" id="time-days" value="1095" class="w-full p-3 border border-slate-300 rounded-lg" oninput="calcTimeLimit()">
                            <div class="text-xs text-slate-400 mt-1">默认1095天，您可根据招标文件修改为1065等</div>
                        </div>
                    </div>

                    <div id="time-forward-result" class="relative pl-4 space-y-0"></div>
                    <div id="time-backward-result" class="hidden grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="bg-white border-l-4 border-indigo-500 rounded-lg shadow-sm p-6 border border-slate-100">
                            <div class="text-indigo-600 font-semibold mb-2 uppercase tracking-wider text-xs">近三年业绩/信誉</div>
                            <div class="text-3xl font-bold text-slate-800 mb-2" id="backward-3y">--</div>
                            <div class="text-xs text-slate-400">参考起始日 (倒推<span id="backward-days">1095</span>天)</div>
                        </div>
                        <div class="bg-white border-l-4 border-purple-500 rounded-lg shadow-sm p-6 border border-slate-100">
                            <div class="text-purple-600 font-semibold mb-2 uppercase tracking-wider text-xs">近五年业绩/信誉</div>
                            <div class="text-3xl font-bold text-slate-800 mb-2" id="backward-5y">--</div>
                            <div class="text-xs text-slate-400">参考起始日 (倒推1825天)</div>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 10. 日期计算助手 ========== -->
        <section id="tool-datecalc" class="tool-section">
            <div class="max-w-3xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-calendar-alt text-cyan-500"></i>日期计算助手
                </h2>
                <div class="bg-white rounded-2xl shadow-lg border border-slate-100 overflow-hidden">
                    <div class="flex border-b">
                        <button onclick="setDateTab('calc')" id="btn-date-calc" class="flex-1 py-4 text-sm font-bold transition-colors bg-blue-50 text-blue-600 border-b-2 border-blue-500">推算日期</button>
                        <button onclick="setDateTab('diff')" id="btn-date-diff" class="flex-1 py-4 text-sm font-bold transition-colors text-gray-500 hover:bg-gray-50">计算间隔</button>
                    </div>
                    
                    <div class="p-8">
                        <!-- 推算日期 -->
                        <div id="date-calc-panel" class="space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="col-span-2">
                                    <label class="text-xs font-bold text-gray-400 uppercase">基准日期</label>
                                    <input type="date" id="date-base" class="w-full mt-1 p-3 bg-gray-50 border rounded-xl focus:ring-2 focus:ring-blue-500 outline-none">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-400 uppercase">统计方式</label>
                                    <select id="date-type" class="w-full mt-1 p-3 bg-gray-50 border rounded-xl">
                                        <option value="calendar">日历日</option>
                                        <option value="working">工作日 (排除六日)</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-400 uppercase">推算方向</label>
                                    <select id="date-dir" class="w-full mt-1 p-3 bg-gray-50 border rounded-xl">
                                        <option value="1">向后 (未来)</option>
                                        <option value="-1">向前 (过去)</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="flex items-center gap-4">
                                <button onclick="changeDateDays(-1)" class="w-10 h-10 rounded-lg border hover:bg-gray-50"><i class="fas fa-minus text-gray-400"></i></button>
                                <div class="flex-1 text-center">
                                    <input type="number" id="date-days" value="1" class="text-2xl font-bold text-slate-700 w-full text-center bg-transparent border-b border-dashed border-gray-300 focus:border-blue-500 focus:outline-none">
                                    <div class="text-sm font-normal text-gray-400">天 (可输入)</div>
                                </div>
                                <button onclick="changeDateDays(1)" class="w-10 h-10 rounded-lg border hover:bg-gray-50"><i class="fas fa-plus text-gray-400"></i></button>
                            </div>

                            <div class="bg-gradient-to-r from-blue-500 to-blue-600 rounded-2xl p-6 text-white shadow-lg relative overflow-hidden">
                                <div class="relative z-10">
                                    <div class="text-xs opacity-70 font-bold uppercase tracking-widest mb-1">计算结果</div>
                                    <div class="text-4xl font-black tracking-tight" id="date-result">--</div>
                                    <div class="mt-2 flex items-center gap-2 opacity-90 text-sm">
                                        <span class="bg-white/20 px-2 py-0.5 rounded" id="date-week">--</span>
                                        <span id="date-type-label">日历日推算</span>
                                    </div>
                                </div>
                                <i class="fas fa-calendar-check absolute -right-4 -bottom-4 text-9xl opacity-10"></i>
                            </div>
                        </div>

                        <!-- 计算间隔 -->
                        <div id="date-diff-panel" class="hidden space-y-6">
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label class="text-xs font-bold text-gray-400 uppercase">开始日期</label>
                                    <input type="date" id="date-start" class="w-full mt-1 p-3 bg-gray-50 border rounded-xl">
                                </div>
                                <div>
                                    <label class="text-xs font-bold text-gray-400 uppercase">结束日期</label>
                                    <input type="date" id="date-end" class="w-full mt-1 p-3 bg-gray-50 border rounded-xl">
                                </div>
                            </div>
                            <div class="bg-gray-50 rounded-2xl p-6 border border-dashed border-gray-300 grid grid-cols-2 gap-8 text-center">
                                <div>
                                    <div class="text-xs text-gray-400 font-bold uppercase mb-1">自然日历天</div>
                                    <div class="text-3xl font-black text-gray-800" id="diff-cal">0</div>
                                </div>
                                <div class="border-l border-gray-200">
                                    <div class="text-xs text-gray-400 font-bold uppercase mb-1">工作日 (排休)</div>
                                    <div class="text-3xl font-black text-blue-600" id="diff-work">0</div>
                                </div>
                            </div>
                            <p class="text-center text-xs text-gray-400">注：间隔计算通常含开始日，不含结束日</p>
                        </div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 11. 随机抽取系统 ========== -->
        <section id="tool-random" class="tool-section">
            <div class="max-w-4xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-dice text-red-500"></i>随机抽取系统
                </h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6">
                        <label class="block text-sm font-semibold text-slate-700 mb-2">输入列表（每行一个）</label>
                        <textarea id="random-input" class="w-full border border-slate-300 rounded-lg p-3 h-48 resize-none" placeholder="一行一个单位名称"></textarea>
                    </div>
                    <div class="flex flex-col gap-4">
                        <button onclick="doRandomDraw()" class="bg-blue-600 text-white font-bold py-3 rounded-lg hover:bg-blue-700 transition flex items-center justify-center gap-2">
                            <i class="fas fa-random"></i> 开始随机排序
                        </button>
                        <div class="flex-1 border border-slate-300 rounded-lg p-4 overflow-auto bg-slate-50" id="random-result"></div>
                    </div>
                </div>
            </div>
        </section>

        <!-- ========== 12. 发票打印助手 ========== -->
        <section id="tool-invoice" class="tool-section">
            <div class="max-w-6xl mx-auto">
                <h2 class="text-2xl font-bold text-slate-800 mb-6 flex items-center gap-3">
                    <i class="fas fa-print text-pink-500"></i>发票打印助手
                </h2>
                <div class="bg-white rounded-xl shadow-sm border border-slate-200 p-6 mb-6">
                    <div class="flex flex-wrap items-center justify-between gap-4">
                        <div class="flex gap-2">
                            <button onclick="document.getElementById('invoice-file').click()" class="bg-blue-600 text-white px-4 py-2 rounded-lg hover:bg-blue-700 flex items-center gap-2">
                                <i class="fas fa-cloud-upload-alt"></i> 上传文件
                            </button>
                            <input type="file" id="invoice-file" hidden multiple accept="image/*,application/pdf" onchange="processInvoiceFiles(this)">
                            <div class="bg-slate-100 p-1 rounded-lg flex">
                                <button onclick="setInvoiceLayout('2-up')" id="btn-2up" class="px-3 py-1 rounded text-sm bg-white shadow text-blue-600">
                                    <i class="fas fa-columns mr-1"></i>竖向(2张)
                                </button>
                                <button onclick="setInvoiceLayout('4-up')" id="btn-4up" class="px-3 py-1 rounded text-sm text-gray-500">
                                    <i class="fas fa-th mr-1"></i>横向(4张)
                                </button>
                            </div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="clearInvoices()" class="p-2 text-gray-400 hover:text-red-500" title="清空">
                                <i class="fas fa-trash-alt"></i>
                            </button>
                            <button onclick="printInvoices()" id="btn-print-invoice" disabled class="px-6 py-2 rounded-lg font-bold flex items-center gap-2 bg-gray-200 text-gray-400 cursor-not-allowed">
                                <i class="fas fa-print"></i> 打印
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-10" id="invoice-grid">
                    <div class="col-span-full border-2 border-dashed border-gray-300 rounded-xl p-12 text-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-blue-300 transition-all" onclick="document.getElementById('invoice-file').click()">
                        <i class="fas fa-images text-4xl mb-3"></i>
                        <p>点击或拖拽上传 JPG/PNG/PDF 发票</p>
                    </div>
                </div>
                
                <div class="text-center text-sm text-gray-400">
                    <i class="fas fa-info-circle mr-1"></i> 打印时请将"边距"设置为"无"，以获得标准尺寸。
                </div>
            </div>
            <div id="invoice-print-area" class="hidden print:block bg-white"></div>
        </section>
    </main>

    <!-- 打印视图 (专家抽取) -->
    <div id="expert-print-view" class="print-only">
        <div class="max-w-4xl mx-auto p-8">
            <div class="text-center mb-8">
                <h1 class="text-2xl font-bold mb-2 text-black">评标专家抽取结果确认表</h1>
                <div class="text-sm text-gray-500">打印时间: <span id="print-time">--</span></div>
            </div>
            <div class="mb-8 border-2 border-gray-800 p-5 rounded-sm">
                <div class="grid grid-cols-2 gap-4 mb-4 pb-4 border-b border-gray-300">
                    <div class="text-sm"><span class="font-bold">项目名称：</span><span id="print-name">--</span></div>
                    <div class="text-sm"><span class="font-bold">项目编号：</span><span id="print-code">--</span></div>
                </div>
                <div class="grid grid-cols-3 gap-3 text-sm mb-4">
                    <div><span class="font-bold">评委总人数：</span><span id="print-total">--</span> 人</div>
                    <div><span class="font-bold">采购人代表：</span><span id="print-rep">--</span> 人</div>
                    <div><span class="font-bold">需抽取专家：</span><span id="print-needed">--</span> 人</div>
                </div>
                <div class="text-sm mb-4">
                    <span class="font-bold">抽取规则：</span>
                    <div class="pl-4 mt-2 grid grid-cols-2 gap-2" id="print-rules"></div>
                </div>
                <div class="text-sm border-t border-gray-300 pt-4">
                    <span class="font-bold">回避单位：</span><span id="print-avoid">--</span>
                </div>
            </div>
            <h2 class="text-lg font-bold mb-3 border-l-4 border-black pl-3 text-black">抽取成功人员名单</h2>
            <table class="w-full border-collapse border border-gray-400 mb-8 text-sm">
                <thead>
                    <tr class="bg-gray-100">
                        <th class="border border-gray-400 p-2 w-12 text-center">序号</th>
                        <th class="border border-gray-400 p-2 w-24 text-center">姓名</th>
                        <th class="border border-gray-400 p-2 w-40">抽取专业</th>
                        <th class="border border-gray-400 p-2">工作单位</th>
                        <th class="border border-gray-400 p-2 w-32 text-center">联系电话</th>
                        <th class="border border-gray-400 p-2 w-24 text-center">签字</th>
                    </tr>
                </thead>
                <tbody id="print-experts"></tbody>
            </table>
            <div class="mt-16 grid grid-cols-2 gap-16 px-8">
                <div>
                    <div class="mb-10 font-bold text-sm">监督人员签字：</div>
                    <div class="border-b border-black w-full"></div>
                    <div class="text-xs text-gray-500 mt-1">日期：&nbsp;&nbsp;&nbsp;&nbsp;年&nbsp;&nbsp;&nbsp;&nbsp;月&nbsp;&nbsp;&nbsp;&nbsp;日</div>
                </div>
                <div>
                    <div class="mb-10 font-bold text-sm">工作人员签字：</div>
                    <div class="border-b border-black w-full"></div>
                    <div class="text-xs text-gray-500 mt-1">日期：&nbsp;&nbsp;&nbsp;&nbsp;年&nbsp;&nbsp;&nbsp;&nbsp;月&nbsp;&nbsp;&nbsp;&nbsp;日</div>
                </div>
            </div>
        </div>
    </div>

    <!-- 补抽弹窗 -->
    <div id="redraw-modal" class="fixed inset-0 bg-black/50 z-50 hidden items-center justify-center">
        <div class="bg-white rounded-lg p-6 w-96 shadow-xl">
            <h3 class="font-bold mb-4 flex items-center gap-2"><i class="fas fa-sync-alt"></i> 选择补抽专业</h3>
            <div class="space-y-2 mb-4 max-h-60 overflow-y-auto custom-scrollbar" id="redraw-list"></div>
            <button onclick="closeRedrawModal()" class="w-full py-2 bg-slate-200 rounded hover:bg-slate-300 text-sm font-medium">取消</button>
        </div>
    </div>

    <!-- 加载提示 -->
    <div id="loading-overlay" class="fixed inset-0 z-50 bg-white/80 hidden items-center justify-center backdrop-blur-sm">
        <div class="flex flex-col items-center">
            <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-2"></i>
            <p>正在处理文件...</p>
        </div>
    </div>



    <script>
        // ========== 通用工具函数 ==========
        const formatCurrency = (num) => new Intl.NumberFormat('zh-CN', { minimumFractionDigits: 2, maximumFractionDigits: 2 }).format(num || 0);
        const formatDate = (date) => {
            if (!date) return '';
            const d = new Date(date);
            const y = d.getFullYear();
            const m = String(d.getMonth() + 1).padStart(2, '0');
            const day = String(d.getDate()).padStart(2, '0');
            return `${y}-${m}-${day}`;
        };
        const addDays = (dateStr, days) => {
            const result = new Date(dateStr);
            result.setDate(result.getDate() + days);
            return result;
        };
        const subtractDays = (dateStr, days) => {
            const result = new Date(dateStr);
            result.setDate(result.getDate() - days);
            return result;
        };
        const isWeekend = (date) => {
            const day = date.getDay();
            return day === 0 || day === 6;
        };

        // ========== 导航切换 ==========
        document.querySelectorAll('.nav-item').forEach(item => {
            item.addEventListener('click', () => {
                document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
                item.classList.add('active');
                const toolId = item.dataset.tool;
                document.querySelectorAll('.tool-section').forEach(s => s.classList.remove('active'));
                document.getElementById('tool-' + toolId).classList.add('active');
            });
        });

        // 默认显示第一个工具
        document.querySelector('.nav-item[data-tool="consulting"]').click();

        // ========== 1. 前期咨询收费 ==========
        const INVEST_BRACKETS = [3000, 10000, 50000, 100000, 500000];
        const SERVICE_TYPES = [
            { id: 'proposal_prep', name: '编制项目建议书', fees: [6, 14, 37, 55, 100], over50eRange: [100, 125] },
            { id: 'feasibility_prep', name: '编制可行性研究报告', fees: [12, 28, 75, 110, 200], over50eRange: [200, 250] },
            { id: 'proposal_eval', name: '评估项目建议书', fees: [4, 8, 12, 15, 17], over50eRange: [17, 20] },
            { id: 'feasibility_eval', name: '评估可行性研究报告', fees: [5, 10, 15, 20, 25], over50eRange: [25, 35] }
        ];

        ['consult-invest', 'consult-unit', 'consult-type', 'consult-coeff'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', calcConsultingFee);
        });

        function calcConsultingFee() {
            const invest = parseFloat(document.getElementById('consult-invest').value);
            const unit = document.getElementById('consult-unit').value;
            const typeId = document.getElementById('consult-type').value;
            const coeff = parseFloat(document.getElementById('consult-coeff').value) || 1;

            if (isNaN(invest) || invest <= 0) {
                document.getElementById('consult-result').innerHTML = '0.00 <span class="text-lg font-normal">万元</span>';
                return;
            }

            const investInWan = unit === 'yiyuan' ? invest * 10000 : invest;
            const service = SERVICE_TYPES.find(s => s.id === typeId);
            let baseFee = 0;

            if (investInWan < 3000) baseFee = (investInWan / 3000) * service.fees[0];
            else if (investInWan > 500000) baseFee = service.over50eRange[0];
            else {
                for (let i = 0; i < INVEST_BRACKETS.length - 1; i++) {
                    if (investInWan >= INVEST_BRACKETS[i] && investInWan <= INVEST_BRACKETS[i+1]) {
                        const x1 = INVEST_BRACKETS[i], x2 = INVEST_BRACKETS[i+1], y1 = service.fees[i], y2 = service.fees[i+1];
                        baseFee = y1 + (y2 - y1) * ((investInWan - x1) / (x2 - x1));
                        break;
                    }
                }
            }
            document.getElementById('consult-result').innerHTML = formatCurrency(baseFee * coeff) + ' <span class="text-lg font-normal">万元</span>';
        }

        // ========== 2. 工程设计收费 ==========
        const designTable = [
            {x:200,y:9.0},{x:500,y:20.9},{x:1000,y:38.8},{x:3000,y:103.8},{x:5000,y:163.9},
            {x:8000,y:249.6},{x:10000,y:304.8},{x:20000,y:566.8},{x:40000,y:1054.0},{x:60000,y:1515.2},
            {x:80000,y:1960.1},{x:100000,y:2393.4},{x:200000,y:4450.8},{x:400000,y:8276.7},
            {x:600000,y:11897.5},{x:800000,y:15391.4},{x:1000000,y:18793.8},{x:2000000,y:34948.9}
        ];

        ['design-invest', 'design-prof', 'design-complex', 'design-add', 'design-float'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', calcDesignFee);
        });

        function calcDesignFee() {
            const invest = parseFloat(document.getElementById('design-invest').value);
            const prof = parseFloat(document.getElementById('design-prof').value) || 1;
            const complex = parseFloat(document.getElementById('design-complex').value) || 1;
            const add = parseFloat(document.getElementById('design-add').value) || 1;
            const floatRate = parseFloat(document.getElementById('design-float').value) || 0;

            if (!invest || invest < 0) {
                document.getElementById('design-total').innerHTML = '0.00 <span class="text-lg text-orange-200 font-normal">万元</span>';
                document.getElementById('design-basic').textContent = '0.00';
                document.getElementById('design-base').textContent = '0.00';
                return;
            }

            let basePrice = 0;
            if (invest > 2000000) basePrice = invest * 0.016;
            else if (invest <= 200) basePrice = (invest/200) * 9.0;
            else {
                for(let i=0; i<designTable.length-1; i++) {
                    if (invest >= designTable[i].x && invest <= designTable[i+1].x) {
                        basePrice = designTable[i].y + (designTable[i+1].y - designTable[i].y) * (invest - designTable[i].x) / (designTable[i+1].x - designTable[i].x);
                        break;
                    }
                }
            }
            const basicFee = basePrice * prof * complex * add;
            const final = basicFee * (1 + floatRate/100);
            document.getElementById('design-total').innerHTML = formatCurrency(final) + ' <span class="text-lg text-orange-200 font-normal">万元</span>';
            document.getElementById('design-basic').textContent = formatCurrency(basicFee);
            document.getElementById('design-base').textContent = formatCurrency(basePrice);
        }

        // ========== 3. 工程造价收费 ==========
        const costRatesTable = [
            [3, 2.5, 2, 1.8, 1.6, 1.5],
            [5, 4, 3, 2.2, 1.8, 1.5],
            [2, 1.8, 1.6, 1.4, 1.2, 1.0],
            [4, 3.5, 3, 2.5, 2, 1.5],
            [8, 7, 6, 5, 4, 3],
            [0, 0, 0, 12, 10, 8],
            [2, 1.5, 1.2, 1.0, 0.8, 0.6],
            [12, 10, 8, 6, 5, 4]
        ];
        const costBrackets = [200, 500, 2000, 10000, 50000];

        document.getElementById('cost-steel-check')?.addEventListener('change', function(e) {
            document.getElementById('cost-steel-input').className = e.target.checked ? 'block mt-2' : 'hidden mt-2';
        });

        function calculateCost() {
            const typeIndex = parseInt(document.getElementById('cost-type').value);
            const basePrice = parseFloat(document.getElementById('cost-base').value);
            const profAdjust = parseFloat(document.getElementById('cost-prof').value);
            const regAdjust = parseFloat(document.getElementById('cost-region').value);
            
            if (isNaN(basePrice) || basePrice <= 0) {
                alert("请输入正确的造价金额");
                return;
            }

            const rates = costRatesTable[typeIndex];
            let totalBaseFee = 0;
            let remaining = basePrice;
            let lastBracket = 0;
            let detailsHtml = "";

            for (let i = 0; i <= costBrackets.length; i++) {
                let currentBracket = i < costBrackets.length ? costBrackets[i] : Infinity;
                let currentRate = rates[i];
                let rangeWidth = currentBracket - lastBracket;
                let amountInThisBracket = Math.min(Math.max(remaining, 0), rangeWidth);
                
                if (amountInThisBracket > 0) {
                    let fee = amountInThisBracket * 10000 * (currentRate / 1000);
                    totalBaseFee += fee;
                    detailsHtml += `
                        <tr class="bg-white border-b">
                            <td class="px-4 py-2">${lastBracket} - ${currentBracket === Infinity ? '以上' : currentBracket}</td>
                            <td class="px-4 py-2">${currentRate}</td>
                            <td class="px-4 py-2">${amountInThisBracket.toFixed(2)}</td>
                            <td class="px-4 py-2">${fee.toFixed(2)}</td>
                        </tr>
                    `;
                }
                remaining -= rangeWidth;
                lastBracket = currentBracket;
                if (remaining <= 0 && currentBracket !== Infinity) break;
            }

            if (typeIndex === 5 && basePrice < 2000) {
                alert("温馨提示：根据标准，全过程造价咨询通常适用于2000万元以上项目，已为您按费率计算，请注意合同约定。");
            }

            let steelFee = 0;
            if (document.getElementById('cost-steel-check').checked) {
                const weight = parseFloat(document.getElementById('cost-steel-weight').value) || 0;
                const steelRate = (typeIndex === 4) ? 18 : 12;
                steelFee = weight * steelRate;
            }

            const finalTotal = totalBaseFee * profAdjust * regAdjust + steelFee;

            document.getElementById('cost-placeholder').classList.add('hidden');
            document.getElementById('cost-content').classList.remove('hidden');
            document.getElementById('cost-detail').classList.remove('hidden');

            document.getElementById('cost-res-base').innerText = totalBaseFee.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('cost-res-prof').innerText = profAdjust;
            document.getElementById('cost-res-reg').innerText = regAdjust;
            document.getElementById('cost-res-steel').innerText = steelFee.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('cost-res-total').innerText = finalTotal.toLocaleString(undefined, {minimumFractionDigits: 2});
            document.getElementById('cost-detail-body').innerHTML = detailsHtml;
        }

        // ========== 4. 工程监理收费 ==========
        const superTable = [
            {l:500,v:16.5}, {l:1000,v:30.1}, {l:3000,v:78.1}, {l:5000,v:120.8}, {l:8000,v:181.0},
            {l:10000,v:218.6}, {l:20000,v:393.4}, {l:40000,v:708.2}, {l:60000,v:991.4}, {l:80000,v:1255.8},
            {l:100000,v:1507.0}, {l:200000,v:2712.5}, {l:400000,v:4882.6}, {l:600000,v:6835.6},
            {l:800000,v:8658.4}, {l:1000000,v:10390.1}
        ];

        ['super-invest', 'super-ind', 'super-comp', 'super-float'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', calcSupervisionFee);
        });

        function calcSupervisionFee() {
            const invest = parseFloat(document.getElementById('super-invest').value);
            const ind = parseFloat(document.getElementById('super-ind').value) || 1;
            const comp = parseFloat(document.getElementById('super-comp').value) || 1;
            const floatRate = parseFloat(document.getElementById('super-float').value) || 0;

            if (!invest || invest < 0) {
                document.getElementById('super-total').innerHTML = '0.00 <span class="text-lg text-teal-200 font-normal">万元</span>';
                document.getElementById('super-base').textContent = '0.00';
                return;
            }

            let base = 0;
            if (invest < 500) base = (invest/500)*16.5;
            else if (invest > 1000000) base = invest * 0.01039;
            else {
                for(let i=0; i<superTable.length-1; i++) {
                    if (invest >= superTable[i].l && invest <= superTable[i+1].l) {
                        base = superTable[i].v + (invest - superTable[i].l) * (superTable[i+1].v - superTable[i].v) / (superTable[i+1].l - superTable[i].l);
                        break;
                    }
                }
            }
            const final = base * ind * comp * (1 + floatRate/100);
            document.getElementById('super-total').innerHTML = formatCurrency(final) + ' <span class="text-lg text-teal-200 font-normal">万元</span>';
            document.getElementById('super-base').textContent = formatCurrency(base);
        }

        // ========== 5. 专家抽取系统 ==========
        let expertGovData = [];
        let expertCompData = [];
        let currentExpertLib = 'gov';
        let expertMajors = [];
        let expertRules = [];
        let drawnExperts = [];
        let selectedMajor = '';

        function handleExpertFile(input, type) {
            const file = input.files[0];
            if (!file) return;
            const encoding = document.getElementById('expert-encoding').value;

            Papa.parse(file, {
                encoding: encoding,
                skipEmptyLines: true,
                complete: (results) => {
                    const rawData = results.data;
                    let processedData = [];
                    
                    const startIndex = type === 'gov' ? 1 : 2;
                    
                    for (let i = startIndex; i < rawData.length; i++) {
                        const row = rawData[i];
                        if (!row || row.length < 3 || !row[0]) continue;

                        let expertMajors = [];
                        for (let j = 3; j < row.length; j++) {
                            if (row[j]) {
                                const cellMajors = row[j].split(/[;；\n]/);
                                cellMajors.forEach(m => {
                                    const c = m.replace(/["\n\r]/g, '').trim();
                                    if (c) expertMajors.push(c);
                                });
                            }
                        }
                        processedData.push({
                            id: `${type === 'gov' ? 'ZC' : 'ZH'}-${i}`,
                            name: row[0],
                            company: row[1],
                            phone: row[2],
                            allMajors: expertMajors,
                            source: type === 'gov' ? '政府采购库' : '综合库'
                        });
                    }

                    if (type === 'gov') {
                        expertGovData = processedData;
                        document.getElementById('gov-count').textContent = `${processedData.length}人`;
                        document.getElementById('gov-upload-label').classList.add('bg-blue-50', 'border-blue-300', 'text-blue-700');
                    } else {
                        expertCompData = processedData;
                        document.getElementById('comp-count').textContent = `${processedData.length}人`;
                        document.getElementById('comp-upload-label').classList.add('bg-green-50', 'border-green-300', 'text-green-700');
                    }
                    updateMajorList();
                },
                error: (err) => alert("解析失败: " + err.message)
            });
        }

        function updateMajorList() {
            const data = currentExpertLib === 'gov' ? expertGovData : expertCompData;
            const allTags = new Set();
            data.forEach(p => p.allMajors.forEach(m => allTags.add(m)));
            expertMajors = Array.from(allTags).sort();
            filterMajors();
        }

        function setExpertLib(lib) {
            currentExpertLib = lib;
            document.getElementById('btn-gov').className = lib === 'gov' ? 'flex-1 py-1.5 text-sm rounded-md transition bg-white shadow text-blue-700 font-bold' : 'flex-1 py-1.5 text-sm rounded-md transition text-slate-500 hover:text-slate-700';
            document.getElementById('btn-comp').className = lib === 'comp' ? 'flex-1 py-1.5 text-sm rounded-md transition bg-white shadow text-green-700 font-bold' : 'flex-1 py-1.5 text-sm rounded-md transition text-slate-500 hover:text-slate-700';
            updateMajorList();
            expertRules = [];
            drawnExperts = [];
            selectedMajor = '';
            renderRules();
            renderExpertResults();
        }

        function filterMajors() {
            const search = document.getElementById('expert-search').value.toLowerCase();
            document.getElementById('clear-search').classList.toggle('hidden', !search);
            
            const filtered = search ? expertMajors.filter(m => m.toLowerCase().includes(search)) : expertMajors;
            
            const listEl = document.getElementById('major-list');
            if (expertMajors.length === 0) {
                listEl.innerHTML = `
                    <div class="h-full flex flex-col items-center justify-center text-slate-400 text-sm">
                        <i class="fas fa-search text-2xl mb-2 opacity-20"></i>
                        请先上传专家库文件
                    </div>`;
                return;
            }
            
            listEl.innerHTML = filtered.map(m => `
                <div onclick="selectMajor('${m.replace(/'/g, "\\'")}')" ondblclick="quickAddRule('${m.replace(/'/g, "\\'")}')"
                    class="px-3 py-2 cursor-pointer text-sm border-b border-slate-50 last:border-0 flex justify-between items-center transition-colors select-none ${selectedMajor === m ? 'bg-blue-100 text-blue-800 font-bold border-l-4 border-l-blue-600' : 'text-slate-700 hover:bg-slate-100'}">
                    <span>${m}</span>
                    ${selectedMajor === m ? '<i class="fas fa-check text-blue-600"></i>' : ''}
                </div>
            `).join('');
        }

        function clearSearch() {
            document.getElementById('expert-search').value = '';
            filterMajors();
        }

        function selectMajor(major) {
            selectedMajor = major;
            filterMajors();
        }

        function quickAddRule(major) {
            selectedMajor = major;
            filterMajors();
            addExpertRule();
        }

        function addExpertRule() {
            if (!selectedMajor) {
                alert("请先在列表中选择一个专业");
                return;
            }
            const count = parseInt(document.getElementById('expert-count').value);
            if (!count || count < 1) {
                alert("抽取人数至少为1");
                return;
            }
            
            const existing = expertRules.find(r => r.major === selectedMajor);
            if (existing) {
                if(confirm(`专业【${selectedMajor}】已存在规则（抽取 ${existing.count} 人）。是否覆盖为 ${count} 人？`)) {
                    expertRules = expertRules.map(r => r.major === selectedMajor ? {...r, count: count} : r);
                }
            } else {
                expertRules.push({ major: selectedMajor, count: count, id: Date.now() });
            }
            
            selectedMajor = '';
            document.getElementById('expert-search').value = '';
            filterMajors();
            renderRules();
        }

        function removeRule(id) {
            expertRules = expertRules.filter(r => r.id !== id);
            renderRules();
        }

        function renderRules() {
            const container = document.getElementById('rule-list');
            const totalNeeded = (parseInt(document.getElementById('expert-total').value) || 5) - (parseInt(document.getElementById('expert-rep').value) || 1);
            const currentTotal = expertRules.reduce((sum, r) => sum + r.count, 0);
            const isValid = totalNeeded === currentTotal && expertRules.length > 0;
            
            document.getElementById('rule-count').textContent = `${currentTotal} / ${totalNeeded} 人`;
            document.getElementById('rule-count').className = `px-2 py-0.5 rounded ${isValid ? 'bg-green-100 text-green-700' : 'bg-amber-100 text-amber-700'}`;
            
            container.innerHTML = expertRules.map(r => `
                <div class="flex justify-between items-center bg-white p-2.5 rounded border border-slate-200 text-sm shadow-sm">
                    <span class="truncate font-medium text-slate-700">${r.major}</span>
                    <div class="flex items-center gap-3">
                        <span class="font-bold text-blue-700">${r.count}人</span>
                        <button onclick="removeRule(${r.id})" class="text-slate-300 hover:text-red-500 transition">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `).join('');
            
            const btnDraw = document.getElementById('btn-draw');
            btnDraw.disabled = expertRules.length === 0;
            btnDraw.className = `w-full py-3 rounded-lg shadow-sm font-bold text-white flex justify-center items-center gap-2 transition ${isValid && expertRules.length > 0 ? 'bg-blue-600 hover:bg-blue-700' : 'bg-slate-400 cursor-not-allowed'}`;
        }

        ['expert-total', 'expert-rep'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', () => {
                const total = parseInt(document.getElementById('expert-total').value) || 5;
                const rep = parseInt(document.getElementById('expert-rep').value) || 1;
                document.getElementById('expert-needed').textContent = Math.max(0, total - rep);
                renderRules();
            });
        });

        function drawExperts() {
            if (expertRules.length === 0) return;
            
            const currentPool = currentExpertLib === 'gov' ? expertGovData : expertCompData;
            const avoidList = document.getElementById('expert-avoid').value.split(/[,， ]/).filter(Boolean);
            let newDrawnList = [];
            let existingIds = new Set();

            for (const rule of expertRules) {
                let pool = currentPool.filter(p => p.allMajors.some(m => m === rule.major));
                let validPool = pool.filter(p => {
                    if (existingIds.has(p.id)) return false;
                    if (avoidList.some(comp => p.company && p.company.includes(comp))) return false;
                    return true;
                });

                if (validPool.length < rule.count) {
                    alert(`【${rule.major}】专业符合条件人数不足！需 ${rule.count} 人，仅剩 ${validPool.length} 人。`);
                    return;
                }

                const shuffled = [...validPool].sort(() => 0.5 - Math.random());
                const selected = shuffled.slice(0, rule.count);

                selected.forEach(p => {
                    newDrawnList.push({ ...p, status: 'pending', log: '系统抽取', matchedMajor: rule.major });
                    existingIds.add(p.id);
                });
            }
            drawnExperts = newDrawnList;
            renderExpertResults();
        }

        function renderExpertResults() {
            const stats = {
                total: drawnExperts.length,
                confirmed: drawnExperts.filter(e => e.status === 'confirmed').length,
                rejected: drawnExperts.filter(e => e.status === 'rejected').length,
                pending: drawnExperts.filter(e => e.status === 'pending').length,
            };
            
            document.getElementById('stat-total').textContent = stats.total;
            document.getElementById('stat-pending').textContent = stats.pending;
            document.getElementById('stat-confirmed').textContent = stats.confirmed;
            document.getElementById('stat-rejected').textContent = stats.rejected;
            document.getElementById('result-count').textContent = `(${drawnExperts.length}人)`;
            
            document.getElementById('btn-export').disabled = drawnExperts.length === 0;
            document.getElementById('btn-redraw').disabled = expertRules.length === 0;
            document.getElementById('btn-print-invoice').disabled = drawnExperts.length === 0;
            
            const container = document.getElementById('expert-results');
            if (drawnExperts.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-16 text-slate-400">
                        <i class="fas fa-search text-4xl mb-2 opacity-20"></i>
                        <p class="text-sm">暂无数据，请先配置规则并抽取</p>
                    </div>`;
                return;
            }
            
            container.innerHTML = drawnExperts.map((e, idx) => `
                <div class="border rounded-lg p-3 flex justify-between items-center ${e.status === 'confirmed' ? 'bg-green-50 border-green-200' : e.status === 'rejected' ? 'bg-red-50 border-red-100' : 'bg-white hover:border-blue-300'}">
                    <div>
                        <div class="flex items-center gap-2 mb-1">
                            <span class="font-bold text-slate-800">${e.name}</span>
                            <span class="text-[10px] px-1.5 py-0.5 rounded bg-slate-100 text-slate-500 border">${e.matchedMajor}</span>
                        </div>
                        <div class="text-xs text-slate-500">${e.company} | ${e.phone}</div>
                        ${e.status === 'rejected' ? `<div class="text-xs text-red-500 mt-1">原因: ${e.log}</div>` : ''}
                    </div>
                    <div class="flex gap-1">
                        ${e.status !== 'rejected' ? `
                            <button onclick="updateExpertStatus('${e.id}', 'confirmed')" class="p-2 rounded ${e.status === 'confirmed' ? 'bg-green-500 text-white' : 'bg-slate-100 text-slate-400 hover:text-green-600'}">
                                <i class="fas fa-check"></i>
                            </button>
                            <button onclick="rejectExpert('${e.id}')" class="p-2 rounded bg-slate-100 text-slate-400 hover:text-red-600">
                                <i class="fas fa-times"></i>
                            </button>
                        ` : ''}
                    </div>
                </div>
            `).join('');
        }

        function updateExpertStatus(id, status) {
            drawnExperts = drawnExperts.map(e => e.id === id ? { ...e, status, log: status === 'confirmed' ? '已确认' : e.log } : e);
            renderExpertResults();
        }

        function rejectExpert(id) {
            const reason = prompt("请输入未参加原因:");
            if (reason) {
                drawnExperts = drawnExperts.map(e => e.id === id ? { ...e, status: 'rejected', log: reason } : e);
                renderExpertResults();
            }
        }

        function clearExperts() {
            if (confirm('清空所有结果？')) {
                drawnExperts = [];
                renderExpertResults();
            }
        }

        function showRedrawModal() {
            const list = document.getElementById('redraw-list');
            list.innerHTML = expertRules.map(r => `
                <button onclick="redrawForMajor('${r.major.replace(/'/g, "\\'")}')" class="w-full text-left p-3 rounded border hover:bg-blue-50 hover:border-blue-300 flex justify-between group">
                    <span>${r.major}</span>
                    <span class="text-xs bg-blue-100 text-blue-700 px-2 py-0.5 rounded group-hover:bg-blue-200">补1人</span>
                </button>
            `).join('');
            document.getElementById('redraw-modal').classList.remove('hidden');
            document.getElementById('redraw-modal').classList.add('flex');
        }

        function closeRedrawModal() {
            document.getElementById('redraw-modal').classList.add('hidden');
            document.getElementById('redraw-modal').classList.remove('flex');
        }

        function redrawForMajor(major) {
            const currentPool = currentExpertLib === 'gov' ? expertGovData : expertCompData;
            const avoidList = document.getElementById('expert-avoid').value.split(/[,， ]/).filter(Boolean);
            const existingIds = new Set(drawnExperts.map(e => e.id));

            let pool = currentPool.filter(p => p.allMajors.some(m => m === major));
            let validPool = pool.filter(p => {
                if (existingIds.has(p.id)) return false;
                if (avoidList.some(comp => p.company && p.company.includes(comp))) return false;
                return true;
            });

            if (validPool.length === 0) {
                alert(`【${major}】专业无剩余符合条件专家`);
                return;
            }

            const randomOne = validPool[Math.floor(Math.random() * validPool.length)];
            drawnExperts.push({ ...randomOne, status: 'pending', log: '补抽', matchedMajor: major });
            renderExpertResults();
            closeRedrawModal();
        }

        function exportExperts() {
            if (drawnExperts.length === 0) return;
            const format = document.getElementById('export-format').value;
            const projectCode = document.getElementById('expert-project-code').value || '项目';
            
            const data = drawnExperts.map(e => ({
                姓名: e.name, 工作单位: e.company, 联系电话: e.phone,
                抽取专业: e.matchedMajor, 专家库来源: e.source,
                状态: e.status === 'confirmed' ? '已确认' : e.status === 'rejected' ? '未参加' : '待确认',
                备注: e.log
            }));
            
            if (format === 'csv') {
                const BOM = '\uFEFF';
                const csvContent = BOM + Papa.unparse(data, { encoding: 'UTF-8', delimiter: ',', header: true });
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `专家抽取结果_${projectCode}.csv`;
                link.click();
            } else {
                const jsonContent = JSON.stringify(data, null, 2);
                const blob = new Blob([jsonContent], { type: 'application/json;charset=utf-8;' });
                const link = document.createElement("a");
                link.href = URL.createObjectURL(blob);
                link.download = `专家抽取结果_${projectCode}.json`;
                link.click();
            }
        }

        function printExperts() {
            const projectName = document.getElementById('expert-project-name').value || '未填写';
            const projectCode = document.getElementById('expert-project-code').value || '未填写';
            const total = document.getElementById('expert-total').value || 5;
            const rep = document.getElementById('expert-rep').value || 1;
            const needed = Math.max(0, total - rep);
            const avoid = document.getElementById('expert-avoid').value || '无';
            
            document.getElementById('print-time').textContent = new Date().toLocaleString();
            document.getElementById('print-name').textContent = projectName;
            document.getElementById('print-code').textContent = projectCode;
            document.getElementById('print-total').textContent = total;
            document.getElementById('print-rep').textContent = rep;
            document.getElementById('print-needed').textContent = needed;
            document.getElementById('print-avoid').textContent = avoid;
            
            document.getElementById('print-rules').innerHTML = expertRules.length > 0 
                ? expertRules.map(r => `<div>• ${r.major}: ${r.count}人</div>`).join('')
                : '<div class="text-gray-400">未设置抽取规则</div>';
            
            const confirmedExperts = drawnExperts.filter(e => e.status === 'confirmed' || e.status === 'pending');
            document.getElementById('print-experts').innerHTML = confirmedExperts.length > 0
                ? confirmedExperts.map((e, i) => `
                    <tr>
                        <td class="border border-gray-400 p-2 text-center">${i + 1}</td>
                        <td class="border border-gray-400 p-2 text-center font-bold">${e.name}</td>
                        <td class="border border-gray-400 p-2 text-xs">${e.matchedMajor}</td>
                        <td class="border border-gray-400 p-2 text-sm">${e.company}</td>
                        <td class="border border-gray-400 p-2 text-center font-mono">${e.phone}</td>
                        <td class="border border-gray-400 p-2"></td>
                    </tr>
                `).join('')
                : '<tr><td colspan="6" class="p-4 text-center text-gray-400">无确认人员</td></tr>';
            
            window.print();
        }



        // ========== 6. 专家评审费估算 ==========
        let expertFeeMode = 'comprehensive';
        let procLocation = 'local';

        function setExpertFeeMode(mode) {
            expertFeeMode = mode;
            document.getElementById('btn-comprehensive').className = mode === 'comprehensive' ? 'flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-white shadow text-blue-600' : 'flex-1 py-3 rounded-lg text-sm font-bold transition-all text-slate-500';
            document.getElementById('btn-procurement').className = mode === 'procurement' ? 'flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-white shadow text-emerald-600' : 'flex-1 py-3 rounded-lg text-sm font-bold transition-all text-slate-500';
            document.getElementById('expert-fee-comprehensive').classList.toggle('hidden', mode !== 'comprehensive');
            document.getElementById('expert-fee-procurement').classList.toggle('hidden', mode !== 'procurement');
            calcExpertFee();
        }

        function setProcLocation(loc) {
            procLocation = loc;
            document.getElementById('btn-local').className = loc === 'local' ? 'flex-1 py-1 text-sm border rounded bg-emerald-100 border-emerald-300 text-emerald-800' : 'flex-1 py-1 text-sm border rounded bg-white';
            document.getElementById('btn-remote').className = loc === 'remote' ? 'flex-1 py-1 text-sm border rounded bg-emerald-100 border-emerald-300 text-emerald-800' : 'flex-1 py-1 text-sm border rounded bg-white';
            document.getElementById('proc-level-box').classList.toggle('hidden', loc !== 'remote');
            calcExpertFee();
        }

        document.getElementById('comp-overnight')?.addEventListener('change', function() {
            document.getElementById('comp-day2').classList.toggle('hidden', !this.checked);
            calcExpertFee();
        });

        ['comp-h1', 'comp-m1', 'comp-h2', 'comp-m2', 'proc-h', 'proc-m'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', calcExpertFee);
        });

        function calcExpertFee() {
            if (expertFeeMode === 'comprehensive') {
                calcComprehensiveFee();
            } else {
                calcProcurementFee();
            }
        }

        function calcComprehensiveFee() {
            const isCancelled = document.getElementById('comp-cancelled').checked;
            let fee = 0, logs = [];
            
            if (isCancelled) {
                fee = 200;
                logs.push("项目取消/回避：200元");
            } else {
                const roundT = (h, m) => {
                    const totalM = h * 60 + m;
                    if (totalM === 0) return 0;
                    const roundedH = Math.floor(totalM / 60);
                    const remM = totalM % 60;
                    if (remM === 0) return roundedH;
                    return remM < 30 ? roundedH + 0.5 : roundedH + 1.0;
                };
                
                const h1 = parseInt(document.getElementById('comp-h1').value) || 0;
                const m1 = parseInt(document.getElementById('comp-m1').value) || 0;
                const T1 = roundT(h1, m1);
                let day1 = T1 <= 4 ? 800 : (800 + (T1 - 4) * 100);
                fee += day1;
                logs.push(`第一日(${T1}h): ${day1}元`);
                
                if (document.getElementById('comp-overnight').checked) {
                    const h2 = parseInt(document.getElementById('comp-h2').value) || 0;
                    const m2 = parseInt(document.getElementById('comp-m2').value) || 0;
                    const T2 = roundT(h2, m2);
                    fee += T2 * 100;
                    logs.push(`第二日(${T2}h): ${T2*100}元`);
                }
                
                if (document.getElementById('comp-chair').checked) {
                    fee += 100;
                    logs.push("主任评委: +100元");
                }
            }
            
            document.getElementById('comp-logs').innerHTML = logs.map(l => {
                const [k, v] = l.split(':');
                return `<div class="flex justify-between border-b pb-1"><span>${k}</span><span class="font-mono">${v}</span></div>`;
            }).join('');
            document.getElementById('comp-total').textContent = `¥${fee}`;
        }

        function calcProcurementFee() {
            const h = parseInt(document.getElementById('proc-h').value) || 0;
            const m = parseInt(document.getElementById('proc-m').value) || 0;
            const isLeader = document.getElementById('proc-leader').checked;
            let fee = 0, logs = [];
            
            if (procLocation === 'remote') {
                const totalH = h + m / 60;
                let halfDays = totalH <= 4 ? 1 : (totalH <= 8 ? 2 : Math.ceil(totalH / 4));
                const level = document.getElementById('proc-level').value;
                const rates = { normal: 500, senior: 650, professor: 1250, academician: 2000 };
                fee = halfDays * rates[level];
                logs.push(`异地(${halfDays}个半天): ~${fee}元`);
            } else {
                const mins = h * 60 + m;
                if (mins <= 180) {
                    fee = 400;
                    logs.push("≤3小时: 400元");
                } else {
                    const excess = mins - 180;
                    const exHours = Math.floor(excess / 60);
                    const rem = excess % 60;
                    let extra = exHours * 100 + (rem > 0 ? (rem < 30 ? 50 : 100) : 0);
                    fee = 400 + extra;
                    logs.push(`基础400 + 超时${extra}元`);
                }
            }
            
            if (isLeader) {
                fee += 100;
                logs.push("组长: +100元");
            }
            
            document.getElementById('proc-logs').innerHTML = logs.map(l => {
                const [k, v] = l.split(':');
                return `<div class="flex justify-between border-b pb-1"><span>${k}</span><span class="font-mono">${v}</span></div>`;
            }).join('');
            document.getElementById('proc-total').textContent = `¥${fee}`;
        }

        // ========== 7. 招标代理服务费 ==========
        let agencyType = 'goods';
        const agencyRateTable = [
            {limit:100,rates:{goods:1.5,service:1.5,engineering:1.0}},
            {limit:500,rates:{goods:1.1,service:0.8,engineering:0.7}},
            {limit:1000,rates:{goods:0.8,service:0.45,engineering:0.55}},
            {limit:5000,rates:{goods:0.5,service:0.25,engineering:0.35}},
            {limit:10000,rates:{goods:0.25,service:0.1,engineering:0.2}},
            {limit:100000,rates:{goods:0.05,service:0.05,engineering:0.05}},
            {limit:Infinity,rates:{goods:0.01,service:0.01,engineering:0.01}}
        ];

        function setAgencyType(type) {
            agencyType = type;
            ['goods', 'service', 'engineering'].forEach(t => {
                const btn = document.getElementById('agency-' + t);
                btn.className = t === type ? 'py-2 text-sm rounded border bg-blue-600 text-white' : 'py-2 text-sm rounded border bg-white hover:bg-gray-50';
            });
            calcAgencyFee();
        }

        function calcAgencyFee() {
            const amount = parseFloat(document.getElementById('agency-amount').value);
            const discount = parseFloat(document.getElementById('agency-discount').value) || 100;
            
            if (!amount || amount <= 0) {
                document.getElementById('agency-base').textContent = '¥ 0.00';
                document.getElementById('agency-final').textContent = '¥ 0.00';
                document.getElementById('agency-details').innerHTML = '';
                return;
            }
            
            let amountWan = amount / 10000, total = 0, prev = 0, list = [];
            for (let t of agencyRateTable) {
                let range = (amountWan > t.limit ? t.limit : amountWan) - prev;
                if (range > 0) {
                    let fee = range * (t.rates[agencyType] / 100);
                    total += fee;
                    list.push({range: t.limit === Infinity ? `>${prev}万` : `${prev}-${t.limit}万`, rate: t.rates[agencyType], fee: fee * 10000});
                }
                if (amountWan <= t.limit) break;
                prev = t.limit;
            }
            
            const base = total * 10000;
            const final = base * (discount / 100);
            
            document.getElementById('agency-base').textContent = '¥ ' + formatCurrency(base);
            document.getElementById('agency-final').textContent = '¥ ' + formatCurrency(final);
            document.getElementById('agency-details').innerHTML = list.map(d => 
                `<div class="flex justify-between py-1 border-b border-dashed"><span>${d.range} (${d.rate}%)</span><span>${formatCurrency(d.fee)}</span></div>`
            ).join('');
        }

        // ========== 8. 交易服务费 ==========
        let transType = 'construction';

        function setTransType(type) {
            transType = type;
            document.getElementById('trans-construction').className = type === 'construction' 
                ? 'cursor-pointer border-2 border-blue-600 bg-blue-50 rounded-xl p-4 transition-all'
                : 'cursor-pointer border-2 border-slate-200 rounded-xl p-4 transition-all hover:border-slate-300';
            document.getElementById('trans-service').className = type === 'service'
                ? 'cursor-pointer border-2 border-indigo-600 bg-indigo-50 rounded-xl p-4 transition-all'
                : 'cursor-pointer border-2 border-slate-200 rounded-xl p-4 transition-all hover:border-slate-300';
            calcTransFee();
        }

        function calcTransFee() {
            const isSpecial = document.getElementById('trans-special').checked;
            let total = 0;
            
            if (isSpecial) {
                total = 2000;
            } else {
                const val = parseFloat(document.getElementById('trans-amount').value);
                if (!val || val < 0) total = 0;
                else if (val <= 100) total = 1000;
                else if (val <= 500) total = 2000;
                else if (val <= 1000) total = 5000;
                else if (val <= 3000) total = 12000;
                else if (val <= 5000) total = 28000;
                else if (val <= 10000) total = 40000;
                else total = 50000;
            }
            
            let tendererPart = (transType === 'construction') ? Math.round(total * 0.4) : 0;
            let winnerPart = (transType === 'construction') ? Math.round(total * 0.6) : total;
            
            document.getElementById('trans-total').innerHTML = formatCurrency(total) + ' <span class="text-sm font-normal">元</span>';
            document.getElementById('trans-tenderer').textContent = formatCurrency(tendererPart);
            document.getElementById('trans-winner').textContent = formatCurrency(winnerPart);
        }

        // ========== 9. 依法招标时限计算 ==========
        let timeMode = 'forward';
        let tenderType = 'post-qual';

        function setTimeMode(mode) {
            timeMode = mode;
            document.getElementById('btn-time-forward').className = mode === 'forward' ? 'flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-white shadow text-teal-600' : 'flex-1 py-3 rounded-lg text-sm font-bold transition-all text-slate-500';
            document.getElementById('btn-time-backward').className = mode === 'backward' ? 'flex-1 py-3 rounded-lg text-sm font-bold transition-all bg-white shadow text-indigo-600' : 'flex-1 py-3 rounded-lg text-sm font-bold transition-all text-slate-500';
            document.getElementById('time-base-label').textContent = mode === 'forward' ? '选择起始日期 (如发布公告日)' : '选择开标/评审日期';
            document.getElementById('time-type-box').classList.toggle('hidden', mode !== 'forward');
            document.getElementById('time-days-box').classList.toggle('hidden', mode !== 'backward');
            document.getElementById('time-forward-result').classList.toggle('hidden', mode !== 'forward');
            document.getElementById('time-backward-result').classList.toggle('hidden', mode !== 'backward');
            calcTimeLimit();
        }

        function setTenderType(type) {
            tenderType = type;
            document.getElementById('btn-post-qual').className = type === 'post-qual' ? 'flex-1 py-3 rounded-lg border text-sm font-medium bg-teal-50 border-teal-500 text-teal-700' : 'flex-1 py-3 rounded-lg border text-sm font-medium bg-white text-slate-500 hover:bg-slate-50';
            document.getElementById('btn-pre-qual').className = type === 'pre-qual' ? 'flex-1 py-3 rounded-lg border text-sm font-medium bg-teal-50 border-teal-500 text-teal-700' : 'flex-1 py-3 rounded-lg border text-sm font-medium bg-white text-slate-500 hover:bg-slate-50';
            calcTimeLimit();
        }

        function calcTimeLimit() {
            const baseDate = document.getElementById('time-base').value;
            if (!baseDate) return;
            
            if (timeMode === 'forward') {
                const start = new Date(baseDate);
                let events = [];
                
                if (tenderType === 'post-qual') {
                    const bidDeadline = addDays(baseDate, 21);
                    events = [
                        {date: start, title: "公告发布日 (T)", sub: "基准日", desc: "根据《民法典》201条，本日不计入期间，从次日起算。", reg: "民法典第201条", isStart: true},
                        {date: addDays(baseDate, 5), title: "招标文件发售最短截止", sub: "发售期", desc: "自开始发售之日(不含)起不得少于5日。", reg: "条例第16条"},
                        {date: subtractDays(bidDeadline, 15), title: "澄清/修改最晚截止", sub: "答疑期", desc: "投标截止时间15日前。如不足，必须顺延。", reg: "条例第21条"},
                        {date: subtractDays(bidDeadline, 10), title: "提出异议截止", sub: "异议期", desc: "投标截止时间10日前提出。", reg: "条例第22条"},
                        {date: bidDeadline, title: "最早投标截止时间", sub: "T + 21日", desc: "自发出之日(不含)起不得少于20日。实务中通常T+21日。", reg: "招标投标法第24条", isLast: true}
                    ];
                } else {
                    const saleEnd = addDays(baseDate, 5);
                    const submitDeadline = addDays(saleEnd, 5);
                    events = [
                        {date: start, title: "公告发布日 (T)", sub: "基准日", desc: "本日不计入期间，从次日起算。", reg: "民法典第201条", isStart: true},
                        {date: saleEnd, title: "资格预审文件发售截止", sub: "发售期", desc: "自开始发售之日(不含)起不得少于5日。", reg: "条例第16条"},
                        {date: subtractDays(submitDeadline, 3), title: "澄清/修改最晚截止", sub: "答疑期", desc: "提交申请文件截止时间3日前。", reg: "条例第21条"},
                        {date: submitDeadline, title: "资格预审申请提交截止", sub: "提交截止", desc: "自停止发售之日(不含)起不得少于5日。", reg: "条例第17条", isLast: true}
                    ];
                }
                
                events.sort((a, b) => a.date - b.date);
                
                document.getElementById('time-forward-result').innerHTML = events.map((ev, idx) => `
                    <div class="timeline-item relative pl-8 pb-10">
                        <div class="absolute left-[11px] top-[24px] bottom-0 w-[2px] ${idx === events.length - 1 ? 'hidden' : 'bg-slate-200'}"></div>
                        <div class="absolute left-0 top-1.5 w-6 h-6 rounded-full border-4 z-10 bg-white ${ev.isStart ? 'border-blue-400' : ev.isLast ? 'border-teal-500' : 'border-slate-300'}"></div>
                        <div class="p-4 rounded-lg border transition-all ${ev.isLast ? 'bg-teal-50 border-teal-200 shadow-sm' : 'bg-white border-slate-100 hover:border-slate-300'}">
                            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
                                <div>
                                    <div class="flex items-center gap-2 mb-1">
                                        <span class="text-[10px] font-bold uppercase px-2 py-0.5 rounded ${ev.isStart ? 'bg-blue-100 text-blue-700' : 'bg-slate-100 text-slate-500'}">${ev.sub}</span>
                                        ${ev.reg ? `<span class="text-[10px] text-slate-400 bg-slate-50 px-1 rounded border border-slate-100"><i class="fas fa-gavel mr-1"></i>${ev.reg}</span>` : ''}
                                    </div>
                                    <h3 class="font-bold text-slate-800">${ev.title}</h3>
                                    <p class="text-sm text-slate-500 mt-1">${ev.desc}</p>
                                </div>
                                <div class="text-right">
                                    <div class="text-xl font-mono font-bold text-slate-700">${formatDate(ev.date)}</div>
                                    <div class="text-xs text-slate-400">${ev.isStart ? '不计入期间' : '法定截止日'}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                `).join('');
            } else {
                const days = parseInt(document.getElementById('time-days').value) || 1095;
                document.getElementById('backward-days').textContent = days;
                document.getElementById('backward-3y').textContent = formatDate(subtractDays(baseDate, days));
                document.getElementById('backward-5y').textContent = formatDate(subtractDays(baseDate, 1825));
            }
        }

        // ========== 10. 日期计算助手 ==========
        let dateTab = 'calc';

        function setDateTab(tab) {
            dateTab = tab;
            document.getElementById('btn-date-calc').className = tab === 'calc' ? 'flex-1 py-4 text-sm font-bold transition-colors bg-blue-50 text-blue-600 border-b-2 border-blue-500' : 'flex-1 py-4 text-sm font-bold transition-colors text-gray-500 hover:bg-gray-50';
            document.getElementById('btn-date-diff').className = tab === 'diff' ? 'flex-1 py-4 text-sm font-bold transition-colors bg-blue-50 text-blue-600 border-b-2 border-blue-500' : 'flex-1 py-4 text-sm font-bold transition-colors text-gray-500 hover:bg-gray-50';
            document.getElementById('date-calc-panel').classList.toggle('hidden', tab !== 'calc');
            document.getElementById('date-diff-panel').classList.toggle('hidden', tab !== 'diff');
        }

        function changeDateDays(delta) {
            const input = document.getElementById('date-days');
            input.value = Math.max(0, parseInt(input.value || 0) + delta);
            calcDate();
        }

        ['date-base', 'date-days', 'date-type', 'date-dir', 'date-start', 'date-end'].forEach(id => {
            document.getElementById(id)?.addEventListener('input', calcDate);
        });

        function calcDate() {
            if (dateTab === 'calc') {
                const base = document.getElementById('date-base').value;
                if (!base) {
                    document.getElementById('date-result').textContent = '--';
                    return;
                }
                let d = new Date(base);
                const days = parseInt(document.getElementById('date-days').value) || 0;
                const type = document.getElementById('date-type').value;
                const dir = parseInt(document.getElementById('date-dir').value) || 1;
                
                if (type === 'calendar') {
                    d.setDate(d.getDate() + (days * dir));
                } else {
                    let count = days;
                    while (count > 0) {
                        d.setDate(d.getDate() + dir);
                        if (!isWeekend(d)) count--;
                    }
                }
                const weeks = ['日', '一', '二', '三', '四', '五', '六'];
                document.getElementById('date-result').textContent = formatDate(d);
                document.getElementById('date-week').textContent = '星期' + weeks[d.getDay()];
                document.getElementById('date-type-label').textContent = (type === 'working' ? '工作日' : '日历日') + '推算';
            } else {
                const start = document.getElementById('date-start').value;
                const end = document.getElementById('date-end').value;
                if (!start || !end) {
                    document.getElementById('diff-cal').textContent = '0';
                    document.getElementById('diff-work').textContent = '0';
                    return;
                }
                let s = new Date(start), e = new Date(end);
                if (s > e) [s, e] = [e, s];
                const cal = Math.floor((e - s) / 86400000);
                let work = 0, cur = new Date(s);
                while (cur < e) {
                    if (!isWeekend(cur)) work++;
                    cur.setDate(cur.getDate() + 1);
                }
                document.getElementById('diff-cal').textContent = cal;
                document.getElementById('diff-work').textContent = work;
            }
        }

        // ========== 11. 随机抽取系统 ==========
        function doRandomDraw() {
            const input = document.getElementById('random-input').value;
            const arr = input.split('\n').filter(s => s.trim());
            for (let i = arr.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [arr[i], arr[j]] = [arr[j], arr[i]];
            }
            document.getElementById('random-result').innerHTML = arr.map((r, i) => 
                `<div class="py-1 border-b border-slate-100 last:border-0">${i + 1}. ${r}</div>`
            ).join('');
        }

        // ========== 12. 发票打印助手 ==========
        let invoices = [];
        let invoiceLayout = '2-up';

        if (window.pdfjsLib) {
            window.pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }

        function setInvoiceLayout(layout) {
            invoiceLayout = layout;
            document.getElementById('btn-2up').className = layout === '2-up' ? 'px-3 py-1 rounded text-sm bg-white shadow text-blue-600' : 'px-3 py-1 rounded text-sm text-gray-500';
            document.getElementById('btn-4up').className = layout === '4-up' ? 'px-3 py-1 rounded text-sm bg-white shadow text-blue-600' : 'px-3 py-1 rounded text-sm text-gray-500';
            renderInvoicePrintArea();
        }

        async function processInvoiceFiles(input) {
            const files = Array.from(input.files);
            if (files.length === 0) return;
            
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('flex');
            
            try {
                for (const file of files) {
                    if (file.type.startsWith('image/')) {
                        invoices.push({
                            id: Math.random().toString(36).substr(2, 9),
                            url: URL.createObjectURL(file),
                            name: file.name,
                            rotation: 0
                        });
                    } else if (file.type === 'application/pdf') {
                        const pdfImages = await convertPdfToImages(file);
                        invoices.push(...pdfImages);
                    }
                }
                renderInvoices();
            } catch (err) {
                alert("处理文件失败: " + err.message);
            } finally {
                document.getElementById('loading-overlay').classList.add('hidden');
                document.getElementById('loading-overlay').classList.remove('flex');
            }
        }

        async function convertPdfToImages(file) {
            const arrayBuffer = await file.arrayBuffer();
            const loadingTask = window.pdfjsLib.getDocument({
                data: arrayBuffer,
                cMapUrl: 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/cmaps/',
                cMapPacked: true,
            });
            const pdf = await loadingTask.promise;
            const images = [];
            for (let i = 1; i <= pdf.numPages; i++) {
                const page = await pdf.getPage(i);
                const viewport = page.getViewport({ scale: 2.0 });
                const canvas = document.createElement('canvas');
                const context = canvas.getContext('2d');
                canvas.height = viewport.height;
                canvas.width = viewport.width;
                context.fillStyle = '#FFFFFF';
                context.fillRect(0, 0, canvas.width, canvas.height);
                await page.render({ canvasContext: context, viewport }).promise;
                images.push({
                    id: Math.random().toString(36).substr(2, 9),
                    url: canvas.toDataURL('image/jpeg', 0.8),
                    name: `${file.name} (P${i})`,
                    rotation: 0
                });
            }
            return images;
        }

        function renderInvoices() {
            const grid = document.getElementById('invoice-grid');
            if (invoices.length === 0) {
                grid.innerHTML = `
                    <div class="col-span-full border-2 border-dashed border-gray-300 rounded-xl p-12 text-center text-gray-400 cursor-pointer hover:bg-gray-50 hover:border-blue-300 transition-all" onclick="document.getElementById('invoice-file').click()">
                        <i class="fas fa-images text-4xl mb-3"></i>
                        <p>点击或拖拽上传 JPG/PNG/PDF 发票</p>
                    </div>`;
                document.getElementById('btn-print-invoice').disabled = true;
                document.getElementById('btn-print-invoice').className = 'px-6 py-2 rounded-lg font-bold flex items-center gap-2 bg-gray-200 text-gray-400 cursor-not-allowed';
                return;
            }
            
            grid.innerHTML = invoices.map(inv => `
                <div class="relative group bg-slate-50 border rounded-lg h-48 flex items-center justify-center overflow-hidden">
                    <img src="${inv.url}" class="max-w-full max-h-full object-contain transition-transform" style="transform: rotate(${inv.rotation}deg)">
                    <div class="absolute inset-0 bg-black/50 opacity-0 group-hover:opacity-100 transition-opacity flex items-center justify-center gap-3">
                        <button onclick="rotateInvoice('${inv.id}')" class="w-8 h-8 bg-white rounded-full text-gray-700 hover:text-blue-600 flex items-center justify-center">
                            <i class="fas fa-redo"></i>
                        </button>
                        <button onclick="removeInvoice('${inv.id}')" class="w-8 h-8 bg-white rounded-full text-gray-700 hover:text-red-600 flex items-center justify-center">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                    <div class="absolute bottom-1 right-1 bg-black/60 text-white text-[10px] px-1 rounded">${inv.name.slice(0, 10)}...</div>
                </div>
            `).join('');
            
            document.getElementById('btn-print-invoice').disabled = false;
            document.getElementById('btn-print-invoice').className = 'px-6 py-2 rounded-lg font-bold flex items-center gap-2 bg-green-600 text-white hover:bg-green-700 shadow-md';
            renderInvoicePrintArea();
        }

        function rotateInvoice(id) {
            invoices = invoices.map(inv => inv.id === id ? { ...inv, rotation: (inv.rotation + 90) % 360 } : inv);
            renderInvoices();
        }

        function removeInvoice(id) {
            invoices = invoices.filter(inv => inv.id !== id);
            renderInvoices();
        }

        function clearInvoices() {
            if (confirm('确定清空所有发票吗？')) {
                invoices = [];
                renderInvoices();
            }
        }

        function renderInvoicePrintArea() {
            const chunkSize = invoiceLayout === '2-up' ? 2 : 4;
            const pages = [];
            for (let i = 0; i < invoices.length; i += chunkSize) {
                pages.push(invoices.slice(i, i + chunkSize));
            }
            
            document.getElementById('invoice-print-area').innerHTML = pages.map((pageItems, pageIdx) => `
                <div class="invoice-page relative box-border">
                    <div class="grid w-full h-full gap-4 ${invoiceLayout === '2-up' ? 'grid-cols-1 grid-rows-2' : 'grid-cols-2 grid-rows-2'}">
                        ${pageItems.map(inv => `
                            <div class="relative border border-gray-300 print-dashed-border print-hide-bg flex items-center justify-center overflow-hidden p-4">
                                <img src="${inv.url}" style="transform: rotate(${inv.rotation}deg); max-height: 100%; max-width: 100%;">
                            </div>
                        `).join('')}
                        ${Array.from({ length: chunkSize - pageItems.length }).map(() => `
                            <div class="border border-dashed border-gray-200"></div>
                        `).join('')}
                    </div>
                </div>
            `).join('');
        }

        function printInvoices() {
            setTimeout(() => window.print(), 100);
        }

        // 初始化
        document.addEventListener('DOMContentLoaded', () => {
            // 设置默认日期
            const today = formatDate(new Date());
            ['time-base', 'date-base', 'date-start', 'date-end'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = today;
            });
            
            // 初始化计算
            calcConsultingFee();
            calcDesignFee();
            calcSupervisionFee();
            calcExpertFee();
            calcAgencyFee();
            calcTransFee();
            calcTimeLimit();
            calcDate();
        });
    </script>
</body>
</html>
